<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title id="title-txt">å•†å“ç®¡ç†</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <style>
        body { background: #f6f7fb; }
        .table { background: #fff; }
        .import-form input[type="file"] { width: auto; display: inline-block; }
        .import-form button { margin-left: 8px; }
        .import-tip { font-size: 13px; color: #666; margin-left: 16px;}
        .lang-btn { float:right; }
    </style>
</head>
<body class="container py-4">
    <nav class="mb-3">
      <a href="/" class="btn btn-link" id="nav-home">æ”¶é“¶å°</a>
      <a href="/manage" class="btn btn-link" id="nav-manage">å•†å“ç®¡ç†</a>
      <a href="/sales" class="btn btn-link" id="nav-sales">é”€å”®è®°å½•</a>
      <button class="btn btn-sm btn-secondary lang-btn" onclick="location.href='/settings'">ğŸŒ è¯­è¨€</button>
    </nav>
    <h2 class="mb-4" id="header-title">å•†å“ç®¡ç†</h2>

    <!-- æ‰¹é‡å¯¼å…¥å¯¼å‡ºåŒºåŸŸ -->
    <div class="mb-3 d-flex align-items-center">
      <a href="/export/items" class="btn btn-outline-primary me-3" target="_blank" id="export-btn">å¯¼å‡ºå•†å“Excel</a>
      <form class="import-form" id="importForm" action="/import/items" method="post" enctype="multipart/form-data" style="display:inline;">
        <input type="file" name="file" accept=".xls,.xlsx" required>
        <button class="btn btn-outline-success" type="submit" id="import-btn">å¯¼å…¥å•†å“Excel</button>
      </form>
      <span class="import-tip" id="import-tip">
        å¯¼å…¥æ¨¡æ¿ï¼š<b>æ¡ç ,åç§°,ä»·æ ¼,åº“å­˜</b>ï¼ˆExcelè¡¨å¤´å¿…é¡»ä¸€è‡´ï¼‰
      </span>
    </div>

    <button class="btn btn-success mb-2" onclick="showAddForm()" id="add-btn">æ·»åŠ æ–°å•†å“</button>
    <table class="table table-bordered">
        <thead>
            <tr>
                <th id="th-barcode">æ¡ç </th>
                <th id="th-name">åç§°</th>
                <th id="th-price">ä»·æ ¼</th>
                <th id="th-qty">åº“å­˜</th>
                <th id="th-action">æ“ä½œ</th>
            </tr>
        </thead>
        <tbody id="itemTable"></tbody>
    </table>

    <!-- ç¼–è¾‘/æ·»åŠ å¼¹çª— -->
    <div class="modal" tabindex="-1" id="editModal">
      <div class="modal-dialog">
        <div class="modal-content">
          <form id="editForm" onsubmit="saveItem(event)">
            <div class="modal-header">
              <h5 class="modal-title" id="modalTitle">ç¼–è¾‘å•†å“</h5>
              <button type="button" class="btn-close" onclick="closeModal()"></button>
            </div>
            <div class="modal-body">
                <div class="mb-2">
                  <label id="label-barcode">æ¡ç </label>
                  <input type="text" class="form-control" id="barcodeInput" required>
                </div>
                <div class="mb-2">
                  <label id="label-name">åç§°</label>
                  <input type="text" class="form-control" id="nameInput" required>
                </div>
                <div class="mb-2">
                  <label id="label-price">ä»·æ ¼</label>
                  <input type="number" class="form-control" id="priceInput" required>
                </div>
                <div class="mb-2">
                  <label id="label-qty">åº“å­˜</label>
                  <input type="number" class="form-control" id="qtyInput" required>
                </div>
            </div>
            <div class="modal-footer">
              <button class="btn btn-primary" type="submit" id="save-btn">ä¿å­˜</button>
              <button class="btn btn-secondary" type="button" onclick="closeModal()" id="cancel-btn">å–æ¶ˆ</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <script>
        // å¤šè¯­è¨€æ–‡æœ¬ï¼ˆç®€ä½“ä¸­æ–‡å’ŒéŸ©è¯­ï¼‰
        const LANG = {
            zh: {
                'title': 'å•†å“ç®¡ç†',
                'nav-home': 'æ”¶é“¶å°',
                'nav-manage': 'å•†å“ç®¡ç†',
                'nav-sales': 'é”€å”®è®°å½•',
                'header-title': 'å•†å“ç®¡ç†',
                'export-btn': 'å¯¼å‡ºå•†å“Excel',
                'import-btn': 'å¯¼å…¥å•†å“Excel',
                'import-tip': 'å¯¼å…¥æ¨¡æ¿ï¼š<b>æ¡ç ,åç§°,ä»·æ ¼,åº“å­˜</b>ï¼ˆExcelè¡¨å¤´å¿…é¡»ä¸€è‡´ï¼‰',
                'add-btn': 'æ·»åŠ æ–°å•†å“',
                'th-barcode': 'æ¡ç ',
                'th-name': 'åç§°',
                'th-price': 'ä»·æ ¼',
                'th-qty': 'åº“å­˜',
                'th-action': 'æ“ä½œ',
                'edit-title': 'ç¼–è¾‘å•†å“',
                'label-barcode': 'æ¡ç ',
                'label-name': 'åç§°',
                'label-price': 'ä»·æ ¼',
                'label-qty': 'åº“å­˜',
                'save-btn': 'ä¿å­˜',
                'cancel-btn': 'å–æ¶ˆ',
                'del-confirm': 'ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå•†å“å—ï¼Ÿ'
            },
            ko: {
                'title': 'ìƒí’ˆ ê´€ë¦¬',
                'nav-home': 'í¬ìŠ¤ë©”ì¸',
                'nav-manage': 'ìƒí’ˆ ê´€ë¦¬',
                'nav-sales': 'íŒë§¤ ë‚´ì—­',
                'header-title': 'ìƒí’ˆ ê´€ë¦¬',
                'export-btn': 'ìƒí’ˆ Excel ë‚´ë³´ë‚´ê¸°',
                'import-btn': 'ìƒí’ˆ Excel ê°€ì ¸ì˜¤ê¸°',
                'import-tip': 'ê°€ì ¸ì˜¤ê¸° ì–‘ì‹ï¼š<b>ë°”ì½”ë“œ,ì´ë¦„,ê°€ê²©,ì¬ê³ </b> (ì—‘ì…€ ì²« í–‰ê³¼ ë™ì¼í•´ì•¼ í•¨)',
                'add-btn': 'ì‹ ê·œ ìƒí’ˆ ì¶”ê°€',
                'th-barcode': 'ë°”ì½”ë“œ',
                'th-name': 'ì´ë¦„',
                'th-price': 'ê°€ê²©',
                'th-qty': 'ì¬ê³ ',
                'th-action': 'ì‘ì—…',
                'edit-title': 'ìƒí’ˆ ìˆ˜ì •',
                'label-barcode': 'ë°”ì½”ë“œ',
                'label-name': 'ì´ë¦„',
                'label-price': 'ê°€ê²©',
                'label-qty': 'ì¬ê³ ',
                'save-btn': 'ì €ì¥',
                'cancel-btn': 'ì·¨ì†Œ',
                'del-confirm': 'ì´ ìƒí’ˆì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?'
            }
        };

        // è·å–å½“å‰è¯­è¨€
        function getLang() {
            return localStorage.getItem('lang') || 'zh';
        }
        // è®¾ç½®ç•Œé¢æ–‡æœ¬
        function setLangTexts() {
            let lang = getLang();
            let l = LANG[lang];
            document.documentElement.lang = lang;
            document.getElementById('title-txt').innerText = l['title'];
            document.getElementById('nav-home').innerText = l['nav-home'];
            document.getElementById('nav-manage').innerText = l['nav-manage'];
            document.getElementById('nav-sales').innerText = l['nav-sales'];
            document.getElementById('header-title').innerText = l['header-title'];
            document.getElementById('export-btn').innerText = l['export-btn'];
            document.getElementById('import-btn').innerText = l['import-btn'];
            document.getElementById('import-tip').innerHTML = l['import-tip'];
            document.getElementById('add-btn').innerText = l['add-btn'];
            document.getElementById('th-barcode').innerText = l['th-barcode'];
            document.getElementById('th-name').innerText = l['th-name'];
            document.getElementById('th-price').innerText = l['th-price'];
            document.getElementById('th-qty').innerText = l['th-qty'];
            document.getElementById('th-action').innerText = l['th-action'];
            document.getElementById('modalTitle').innerText = l['edit-title'];
            document.getElementById('label-barcode').innerText = l['label-barcode'];
            document.getElementById('label-name').innerText = l['label-name'];
            document.getElementById('label-price').innerText = l['label-price'];
            document.getElementById('label-qty').innerText = l['label-qty'];
            document.getElementById('save-btn').innerText = l['save-btn'];
            document.getElementById('cancel-btn').innerText = l['cancel-btn'];
        }

        let editingBarcode = null;

        function loadItems() {
            fetch('/api/items').then(res => res.json()).then(data => {
                const tb = document.getElementById('itemTable');
                tb.innerHTML = '';
                data.forEach(item => {
                    tb.innerHTML += `
                        <tr>
                            <td>${item.barcode}</td>
                            <td>${item.name}</td>
                            <td>${item.price}</td>
                            <td>${item.qty}</td>
                            <td>
                                <button class="btn btn-sm btn-warning" onclick="showEditForm('${item.barcode}','${item.name}',${item.price},${item.qty})">${LANG[getLang()]['edit-title']}</button>
                                <button class="btn btn-sm btn-danger" onclick="delItem('${item.barcode}')">${LANG[getLang()]['del-confirm'].split('ï¼Ÿ')[0]}</button>
                            </td>
                        </tr>
                    `;
                });
            });
        }

        function showAddForm() {
            editingBarcode = null;
            document.getElementById('modalTitle').innerText = LANG[getLang()]['add-btn'];
            document.getElementById('barcodeInput').value = '';
            document.getElementById('barcodeInput').disabled = false;
            document.getElementById('nameInput').value = '';
            document.getElementById('priceInput').value = '';
            document.getElementById('qtyInput').value = '';
            document.getElementById('editModal').style.display = 'block';
        }

        function showEditForm(barcode, name, price, qty) {
            editingBarcode = barcode;
            document.getElementById('modalTitle').innerText = LANG[getLang()]['edit-title'];
            document.getElementById('barcodeInput').value = barcode;
            document.getElementById('barcodeInput').disabled = true;
            document.getElementById('nameInput').value = name;
            document.getElementById('priceInput').value = price;
            document.getElementById('qtyInput').value = qty;
            document.getElementById('editModal').style.display = 'block';
        }

        function closeModal() {
            document.getElementById('editModal').style.display = 'none';
        }

        function saveItem(event) {
            event.preventDefault();
            const barcode = document.getElementById('barcodeInput').value;
            const name = document.getElementById('nameInput').value;
            const price = document.getElementById('priceInput').value;
            const qty = document.getElementById('qtyInput').value;
            if (editingBarcode) {
                fetch('/api/item/' + barcode, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({name, price, qty})
                }).then(res => res.json()).then(_ => {
                    closeModal();
                    loadItems();
                });
            } else {
                fetch('/api/item', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({barcode, name, price, qty})
                }).then(res => res.json()).then(_ => {
                    closeModal();
                    loadItems();
                });
            }
        }

        function delItem(barcode) {
            if (!confirm(LANG[getLang()]['del-confirm'])) return;
            fetch('/api/item/' + barcode, {method: 'DELETE'})
            .then(res => res.json()).then(_ => loadItems());
        }

        window.onclick = function(event) {
            if (event.target === document.getElementById('editModal')) {
                closeModal();
            }
        };

        setLangTexts();
        loadItems();
    </script>
</body>
</html>
