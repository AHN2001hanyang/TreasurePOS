<!DOCTYPE html>
<html lang="{{ lang }}">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{{ texts['setting'] }}</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
  <style>
    body{font-family:'Noto Sans KR','Noto Sans SC',-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Helvetica Neue',Arial,sans-serif;background:#f0f2f5;display:flex;align-items:center;justify-content:center;min-height:100vh;margin:0}
    .settings-card{width:100%;max-width:450px;background:#fff;border-radius:16px;box-shadow:0 8px 32px rgba(0,0,0,.1);border:none;overflow:hidden}
    .card-header{background:#fff;border-bottom:1px solid #e9ecef;padding:1.5rem;display:flex;align-items:center;justify-content:space-between}
    .back-link{text-decoration:none;color:#6c757d;font-weight:500;transition:color .2s ease;display:flex;align-items:center}
    .back-link:hover{color:#0d6efd}
    .card-title{font-weight:700;font-size:1.5rem;color:#343a40;margin:0;display:flex;align-items:center}
    .card-title i{font-size:1.7rem;color:#0d6efd;margin-right:.5rem}
    .lang-list .list-group-item{padding:1.25rem 1.5rem;font-size:1.1rem;font-weight:500;color:#495057;border-left:none;border-right:none;border-top-width:0;border-bottom:1px solid #e9ecef;transition:background-color .2s,color .2s;display:flex;justify-content:space-between;align-items:center}
    .lang-list .list-group-item:first-child{border-top-left-radius:0;border-top-right-radius:0}
    .lang-list .list-group-item:last-child{border-bottom:none}
    .lang-list .list-group-item.active{background:#e7f1ff;color:#0d6efd;border-color:#e9ecef}
    .lang-list .list-group-item.active .bi-check-circle-fill{visibility:visible}
    .lang-list .list-group-item .bi-check-circle-fill{visibility:hidden}
    .lang-list .list-group-item-action:hover,.lang-list .list-group-item-action:focus{background:#f8f9fa;color:#0d6efd}
    .card-footer{background:#f8f9fa;color:#adb5bd;font-size:.85rem;text-align:center;padding:.75rem}
    @media (max-width:576px){.settings-card{max-width:99vw}.card-header{padding:1rem}.lang-list .list-group-item{padding:1rem 1rem;font-size:1rem}}
  </style>
</head>
<body>
  <div class="settings-card">
    <div class="card-header">
      <h2 class="card-title">
        <i class="bi bi-gear-fill"></i>{{ texts['setting'] }}
      </h2>
      {# --- 服务器端先算一个安全的返回地址 --- #}
      {% set _ref = request.referrer or '' %}
      {% set back_url = url_for('index') if (not _ref or '/set_lang/' in _ref or _ref.endswith('/settings')) else _ref %}
      <a href="{{ back_url }}" class="back-link" onclick="return smartBack(event)" aria-label="{{ texts['title'] }}">
        <i class="bi bi-arrow-left-circle me-1"></i>{{ texts['title'] }}
      </a>
    </div>

    <div class="list-group list-group-flush lang-list">
      <a href="/set_lang/ko?return={{ request.path }}" class="list-group-item list-group-item-action{% if lang=='ko' %} active{% endif %}" aria-current="{% if lang=='ko' %}true{% else %}false{% endif %}">
        <span>한국어</span><i class="bi bi-check-circle-fill fs-5"></i>
      </a>
      <a href="/set_lang/en?return={{ request.path }}" class="list-group-item list-group-item-action{% if lang=='en' %} active{% endif %}" aria-current="{% if lang=='en' %}true{% else %}false{% endif %}">
        <span>English</span><i class="bi bi-check-circle-fill fs-5"></i>
      </a>
      <a href="/set_lang/zh?return={{ request.path }}" class="list-group-item list-group-item-action{% if lang=='zh' %} active{% endif %}" aria-current="{% if lang=='zh' %}true{% else %}false{% endif %}">
        <span>中文</span><i class="bi bi-check-circle-fill fs-5"></i>
      </a>
    </div>

    <div class="card-footer">
      {{ texts.get('powered_by', 'Powered by Flask-POS') }}
    </div>
  </div>

  <script>
    // 点击“返回”：如果上一页不是 set_lang / settings，就后退；否则直接去首页
    function smartBack(e){
      try{
        const ref = document.referrer || '';
        const isBad = /\/set_lang\/|\/settings$/.test(new URL(ref, location.origin).pathname);
        if(ref && !isBad){
          e.preventDefault();
          history.back();
          return false;
        }
      }catch(_){}
      // 兜底：直接去首页（a 的 href 也已经是一个安全地址）
      return true;
    }
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
